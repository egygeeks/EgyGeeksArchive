{"id":"172338516139198_1188267014546338","from":{"name":"Ahmed Ashraf","id":"760277010801860"},"message":"السلام عليكم\n\nعندي سيرفر 20 كور ، 64 جيجا رام  علي توزيعة اوبنتو 14 \n\nالبيانات اللي السيرفر بيخزنها  في الساعة الواحدة كبيره بشكل ما .. و عندي حوالي 2000 concurrent user .\n\nبستخدم Nginx مع MongoDB و السكربت php .. المشكلة كانت ان الnginx بيرجع 502 bad gateway .. و بعد البحث المشكله كانت في ان الphp5-fpm محتاج يتظبله شويه اعدادات علشان يقدر يهندل الكونكرنت يوزر مع الNgnix .. غيرت ال pm.max_children من 5 ل 70 و حسب اللي مكتوب انه يقدر يخدم 2000 كونكرنت علي رامات 8GB ... وهو فعلاً مش مستهلك من الميموري عندي غير جيجا و نص ولكن الcpu 100% و الحل اني اخلي ال pm.max_children = 20 ماكسيمام علشان الcpu يهدي و يرجع تاني 8% .. ولكن ساعتها مشكله ال bad gateway هترجع تاني \nو حالياً بعد البينشماركينج علي 2000 ريكوست بيقع منهم ما بين ال600  و ال800\n\nحالياً انا محتاج اعرف لو فيه حل للمشكلة دي ؟ و هل الاستهلاك بالشكل ده منطقي ؟","actions":[{"name":"Comment","link":"https://www.facebook.com/172338516139198/posts/1188267014546338"},{"name":"Like","link":"https://www.facebook.com/172338516139198/posts/1188267014546338"},{"name":"Report Post to Admin","link":"https://www.facebook.com/groups/egyptian.geeks/members/"}],"privacy":{"value":"","description":"","friends":"","allow":"","deny":""},"type":"status","created_time":"2016-07-24T12:48:12+0000","updated_time":"2016-07-27T15:38:14+0000","shares":{"count":2},"is_hidden":false,"is_expired":false,"likes":{"data":[{"id":"1142904185832197","name":"Mosaab Ahmed"},{"id":"1285105998248677","name":"Ahmed Badawy"},{"id":"1822709031088736","name":"Mostafa Kasem"},{"id":"10154777096910845","name":"Mohammad Fouad"},{"id":"1422838344455276","name":"Abd El-Rahman Rafaat"},{"id":"1118459391596579","name":"Mohamad Emad"},{"id":"1874246756187183","name":"Ahmed Said"}],"paging":{"cursors":{"before":"MTE0MjkwNDE4NTgzMjE5NwZDZD","after":"MTg3NDI0Njc1NjE4NzE4MwZDZD"}}},"comments":{"data":[{"created_time":"2016-07-24T13:00:23+0000","from":{"name":"Meligy","id":"10154884040385170"},"message":"I don't know much about this, but had a bet that I can find something that appears useful by finding good search terms. So, I'm sorry in advance if this is wasting your time as something you tried or unrelated.\n\nThere seem to be other settings than the ones you mentioned, related to buffers, check the accepted answer here: http://stackoverflow.com/questions/8772015/502-gateway-errors-under-high-load-nginx-php-fpm","can_remove":false,"like_count":1,"user_likes":false,"id":"1188271834545856"},{"created_time":"2016-07-24T13:08:47+0000","from":{"name":"Mohamed El-Sayed","id":"10154294518798309"},"message":"ال 2000 دول كلهم بيروحوا على php و لا في حاجات static ؟","can_remove":false,"like_count":3,"user_likes":false,"id":"1188275011212205"},{"created_time":"2016-07-24T15:45:13+0000","from":{"name":"Mohamed Radwan","id":"10158356933185192"},"message":"best practice : DNS is working as round robin to HA proxy then Ha proxy works as round robin to nginx. Most of high traffic websites using this approach. By the way pass me your nginx configuration","can_remove":false,"like_count":0,"user_likes":false,"id":"1188366794536360"},{"created_time":"2016-07-24T15:47:19+0000","from":{"name":"Mohamed Alaa El Din","id":"1252478278163674"},"message":"You can't just play with fpm configuration without doing measures. What exactly is the error u get in the log??","can_remove":false,"like_count":3,"user_likes":false,"id":"1188367511202955"},{"created_time":"2016-07-24T16:27:41+0000","from":{"name":"Mokhtar Ali Ebrahim","id":"10154396259187742"},"message":"http://myshell.co.uk/blog/2012/07/adjusting-child-processes-for-php-fpm-nginx/","can_remove":false,"like_count":0,"user_likes":false,"id":"1188388287867544"},{"created_time":"2016-07-24T17:01:02+0000","from":{"name":"Usama Fayez","id":"10154898806065280"},"message":"It might be a silly question but why are you using one powerful expensive server instead of a set of cheaper hosts and balancing the load across them?","can_remove":false,"like_count":4,"user_likes":false,"id":"1188405417865831"},{"created_time":"2016-07-24T17:58:30+0000","from":{"name":"سامح دعبس","id":"1873036762957490"},"message":"ماليش في التقنيات اللي انت مستخدمها، بس على iis مشكلة شبيهة بمشكلتك و كان حلها إني أعمل web garden\nو دي ببساطة معناها إني أشغل كذا process عشان تستقبل ال requests\nو كنا بنحط عدد ال worker processes= عدد الcores\nمش عارف حاجة زي دي هاتفيدك و لا لأ\nhttp://stackoverflow.com/questions/7325211/tuning-nginx-worker-process-to-obtain-100k-hits-per-min","can_remove":false,"like_count":0,"user_likes":false,"id":"1188432254529814"},{"created_time":"2016-07-24T18:52:24+0000","from":{"name":"Muhammad Al Rabbani","id":"436443206686932"},"message":"I read this post 3 times and can't understand it, the English words in Arabic letter make it impossibe, sorry","can_remove":false,"like_count":0,"user_likes":false,"id":"1188461284526911"},{"created_time":"2016-07-24T19:34:53+0000","from":{"name":"Muhammad Negm","id":"10212131509466411"},"message":"Why do have this huge cluster in the first place?","can_remove":false,"like_count":0,"user_likes":false,"id":"1188481424524897"},{"created_time":"2016-07-24T19:39:21+0000","from":{"name":"Osama Ali","id":"10155294668972384"},"message":"Sherif Sayed","can_remove":false,"like_count":0,"message_tags":[{"id":"10154159962696619","length":12,"name":"Sherif Sayed","offset":0,"type":"user"}],"user_likes":false,"id":"1188483244524715"},{"created_time":"2016-07-24T19:52:21+0000","from":{"name":"Mohammed Elmadeny","id":"10212796585214807"},"message":"what about the Process manager in php5-fpm is it dynamic or on demand ?","can_remove":false,"like_count":1,"user_likes":false,"id":"1188488474524192"},{"created_time":"2016-07-24T20:28:32+0000","from":{"name":"Ahmed Kamal","id":"10206651440364620"},"message":"Also are you using op code caching, php-apc, also you might need to do some profiling to your code, there might be a problem within.","can_remove":false,"like_count":0,"user_likes":false,"id":"1188502834522756"},{"created_time":"2016-07-24T22:09:50+0000","from":{"name":"Mohammad Fouad","id":"10154777096910845"},"message":"Any idea what the CPU is actually doing? \n- do you have a complicated vhost map in NGINX? maybe it is doing excessive matching\n- do you have NGINX logs enabled? maybe too much I/O and wait times\n- is this by any chance a VM? VM Network traffic can consume CPU if not para-virtualized","can_remove":false,"like_count":1,"user_likes":false,"id":"1188562851183421"},{"created_time":"2016-07-25T00:37:30+0000","from":{"name":"Ahmed M. Araby","id":"10154630737934263"},"message":"It depends on your application code \nBut mostly it's not normal \nThere are indexes in mogo similar to MySQL Indies  \nProbably you don't use any\nAlmost 60 of performance issues bottlenecks are in databases \nYou can do a quick proof of concept by watching how long the php fpm children life span , should be relatively high \nAlso through benchmarking mongo slow queries \nUsing mongo doesnt mean it be super fast just by itself","can_remove":false,"like_count":0,"user_likes":false,"id":"1188625757843797"},{"created_time":"2016-07-25T09:28:59+0000","from":{"name":"Ahmed Mekkawy","id":"10154827860545239"},"message":"Your problem is obviously in the PHP execution load, increasing the children will just kill your CPU. Only one of three methods to use IMHO, I suggest you use the three altogether:\n1. Tune your code so it can perform better.\n2. Leave this server, use cloud computing, choose a high CPU - low RAM provider, you can achieve that on Vultr or Softlayer, depends on your budget.\n3. Tune your workers till you get close to 100% CPU load but the load average is between 1 and 2, and it stays stable for 10 minutes at least. This your maximum sustainable PHP process number on that code. Then you have to use aggressive caching: opcode caching, fragment caching, and full page caching. this link will help you with the latter:\n\nhttp://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_cache\n\nIf you need any further help feel free to ping me, or ping those guys, they are good: Spirula Systems","can_remove":false,"like_count":3,"message_tags":[{"id":"10150099832690088","length":15,"name":"Spirula Systems","offset":880,"type":"page"}],"user_likes":false,"id":"1188831171156589"},{"created_time":"2016-07-25T09:46:14+0000","from":{"name":"Osama Mohamed","id":"830345717112933"},"message":"Ahmed Mahfouz","can_remove":false,"like_count":0,"message_tags":[{"id":"10212072846353700","length":13,"name":"Ahmed Mahfouz","offset":0,"type":"user"}],"user_likes":false,"id":"1188835461156160"},{"created_time":"2016-07-25T09:59:50+0000","from":{"name":"Ahmed Mahfouz","id":"10212072846353700"},"message":"you are right about php-fpm , as nginx is just a proxy for it \nyou can sit this for php_fpm .\nworker_processes = number of cpu cores \nworker_connections = 1024\nmax_children = divided total memory on this size actual size of php-fpm process take \nalso mind the io performance \ngood luck","can_remove":false,"like_count":0,"user_likes":false,"id":"1188838841155822"},{"created_time":"2016-07-25T15:03:22+0000","from":{"name":"Said Bakr","id":"10154979109648745"},"message":"انت ما اتكلمتش عن إعدادات ال php  اللي عندك مثل:\nmax_execution_time\nmax_input_time\nmemory_limit","can_remove":false,"like_count":0,"user_likes":false,"id":"1188974077808965"},{"created_time":"2016-07-25T19:55:06+0000","from":{"name":"Ahmed Badawy","id":"1285105998248677"},"message":"لا مش طبيعي خالص.. طب جرب  علي اي جهاز تاني نفس ال config ده...","can_remove":false,"like_count":0,"user_likes":false,"id":"1189118101127896"},{"created_time":"2016-07-25T20:11:31+0000","from":{"name":"Taha Amin","id":"10154850341220590"},"message":"Ahmed Marzouk يلا لينكاتك بقي","can_remove":false,"like_count":0,"message_tags":[{"id":"1307064242706371","length":13,"name":"Ahmed Marzouk","offset":0,"type":"user"}],"user_likes":false,"id":"1189123311127375"},{"created_time":"2016-07-26T04:55:46+0000","from":{"name":"Ahmed Gaber Elneel","id":"1242995129149151"},"message":"راجع الphp config يا برنس !!! عيب و الله الكلام اللي بتقوله ده -_-","can_remove":false,"like_count":0,"user_likes":false,"id":"1189413287765044"}],"paging":{"cursors":{"before":"WTI5dGJXVnVkRjlqZAFhKemIzSTZANVEU0T0RJM01UZA3pORFUwTlRnMU5qb3hORFk1TXpZAMU1qSTAZD","after":"WTI5dGJXVnVkRjlqZAFhKemIzSTZANVEU0T1RReE16STROemMyTlRBME5Eb3hORFk1TlRBNE9UUTMZD"}}}}